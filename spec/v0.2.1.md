# VTE v0.2.1 Specification

## 1. Goal
Provide a **Verifiable Timelock Encryption (VTE)** package that allows a Verifier to confirm:
1.  **Validity**: The Capsule is a valid timelock encryption under a specific `NetworkID` and `Round`.
2.  **Binding**: The plaintext `r2` inside the capsule is legally bound to a `SessionID` and `RefundTxHash` via `ctxHash`.
3.  **Lockpoint**: The plaintext `r2` corresponds to the public key `R2` (`R2 = r2 * G`), used for adaptor signatures.

## 2. Security Invariants
-   **Invariant A (One-Commitment Binding)**: All proofs must bind to the same commitment `C` to prevent value switching.
-   **Invariant B (No Mod-Field Collision)**: Strict limb-packing for all hashes and values; no direct casting of 32-byte values to field elements.
-   **Invariant C (Strict Network Pinning)**: `trustChainhash` MUST be false. The verifier provides the trusted `chainhash`.
-   **Invariant D (Version Pinning)**: `ciphertext_format_id` must be explicit to handle `tlock` versioning changes.

## 3. Data Model

### 3.1 VTEPackage
```go
struct VTEPackage {
    Round           uint64
    NetworkID       NetworkID
    Capsule         []byte
    CapsuleChecksum []byte // Optional, BLAKE3(Capsule)
    CipherFields    CipherFields // Struct parsed from Capsule
    CtxHash         [32]byte
    C               [32]byte // Commitment
    R2Compressed    [33]byte
    R2Pub           R2PublicInputs // R2x, R2y limbs
    ProofSECP       []byte
    ProofTLE        []byte
}
```

### 3.2 NetworkID
```go
struct NetworkID {
    ChainHash          []byte // Source of truth
    TlockVersion       string
    CiphertextFormatID string
    TrustChainHash     bool   // MUST be false
    DrandEndpoints     []string
}
```

## 4. Verification Algorithm (`VerifyVTE`)

Inputs: `pkg`, `expected_round`, `expected_chainhash`, `expected_format_id`, `expected_ctx_hash`.

1.  **Network Check**: Assert `pkg.NetworkID.ChainHash == expected_chainhash`.
2.  **Round Check**: Assert `pkg.Round == expected_round`.
3.  **Format Check**: Assert `pkg.NetworkID.CiphertextFormatID == expected_format_id`.
4.  **Capsule Integrity**:
    *   `fields = ParseCapsule(pkg.Capsule, expected_format_id)`
    *   Assert `fields == pkg.CipherFields` (exact match).
5.  **Verify Proof_TLE**:
    *   Public Inputs: `Round`, `ChainHash`, `FormatID`, `CtxHash`, `C`, `CipherFields`.
    *   Statement: `CipherFields` are a valid encryption of `r2` (committed in `C`) for `Round` on `ChainHash`.
6.  **Verify Proof_SECP**:
    *   Decompress `R2Compressed` -> `(x, y)`. Check on-curve.
    *   Public Inputs: `CtxHash`, `C`, `R2x`, `R2y`.
    *   Statement: `r2` (committed in `C`) * G == `(R2x, R2y)`.

## 5. Roles
-   **Prover**: Creates the VTEPackage (holds `r2`).
-   **Verifier**: Validates the VTEPackage before funding.
